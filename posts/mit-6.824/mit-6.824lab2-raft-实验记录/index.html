<!DOCTYPE html>
<html lang="zh_CN"><head>
    <meta charset="utf-8"><title>ã€MIT 6.824ã€‘Lab2 Raft å®éªŒè®°å½•&nbsp;-&nbsp;XUN</title>

    <meta name="theme-color" content="#e0e0e0">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="msapplication-navbutton-color" content="#e0e0e0">
    <meta name="apple-mobile-web-app-status-bar-style" content="#e0e0e0">
    
    
    <link rel="icon" type="image/png" href="/HQL.ico">
    
    
    
     
    
    <link rel="stylesheet" href="https://cenjianxun.github.io/scss/main.min.0ffadbc3c2a3797d942bf72a67496fbfe56c8a73d588150e943b4d111febdfdd.css">
    
    
    <script type="text/javascript" src="/js/main.js" defer></script>
</head><body class="mytheme">
  <div class="body-container">
    <aside>
    <div class="nav-title">
        <a href="/" class="home-link" target="_blank">XUN</a>
    </div>
    <section class="sidebar">
        <div id="sidebar-info" class="sidebar-info">
            <div class="sidebar-about">
                <p class="lead">
                    æƒ³å†™ä¸€ä¸ªæ’­æ”¾å™¨æƒ³å†™ä¸€ä¸ªä¼ è¾“å·¥å…·æƒ³å†™ä¸€ä¸ªé€šè®¯å·¥å…·æƒ³åœ¨é«˜é€Ÿå…¬è·¯ä¸Šè‡ªç”±codingä¸€è¾¹å¬æ­Œå¦‚æœä¸€ä¸ªå¤ä»£äººæŠ€èƒ½ç‚¹æ˜¯å†™ä»£ç æ€ä¹ˆåŠ
                </p>
            </div>
            <div class="count">æ–‡ç« </div>
            <div class="social">
                <a href="https://github.com/cenjianxun" target="_blank" rel="noopener noreferrer">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-github">
                        <path d="M15 22v-4a4.8 4.8 0 0 0-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35 0-3.5 0 0-1 0-3 1.5-2.64-.5-5.36-.5-8 0C6 2 5 2 5 2c-.3 1.15-.3 2.35 0 3.5A5.403 5.403 0 0 0 4 9c0 3.5 3 5.5 6 5.5-.39.49-.68 1.05-.85 1.65-.17.6-.22 1.23-.15 1.85v4"/>
                        <path d="M9 18c-4.51 2-5-2-7-2"/> 
                        </svg>
                </a>
                <a href="" target="_blank" rel="noopener noreferrer">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor"  stroke-linecap="round" stroke-linejoin="round"
                        class="lucide lucide-twitter">
                        <path
                            d="M22 4s-.7 2.1-2 3.4c1.6 10-9.4 17.3-18 11.6 2.2.1 4.4-.6 6-2C3 15.5.5 9.6 3 5c2.2 2.6 5.6 4.1 9 4-.9-4.2 4-6.6 7-3.8 1.1 0 3-1.2 3-1.2z">
                        </path>
                    </svg>
                </a>
                <a href=""  target="_blank" rel="noopener noreferrer">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"
                        class="lucide lucide-mail">
                        <rect width="20" height="16" x="2" y="4" rx="2"></rect>
                        <path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"></path>
                    </svg>
                </a>
                <a href=""  target="_blank" rel="noopener noreferrer">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"
                        class="lucide lucide-rss">
                        <path d="M4 11a9 9 0 0 1 9 9"></path>
                        <path d="M4 4a16 16 0 0 1 16 16"></path>
                        <circle cx="5" cy="19" r="1"></circle>
                    </svg>
                </a>
            </div>
        </div>
        
        
            

<div id="sidebar-toc" class="sidebar-toc">
    
    <header>
        <span class="toc-bar"></span>
        <h4 class="toc-header">ã€MIT 6.824ã€‘Lab2 Raft å®éªŒè®°å½•</h4>
        <span class="toc-bar"></span>
    </header>
    
    <nav id="TableOfContents">
  <ul>
    <li><a href="#ç»“æ„å’Œæµç¨‹">ç»“æ„å’Œæµç¨‹</a>
      <ul>
        <li><a href="#çŠ¶æ€æœºé‚£å¼ å›¾">çŠ¶æ€æœºï¼š(é‚£å¼ å›¾)</a></li>
        <li><a href="#term">term:</a></li>
        <li><a href="#ç»“æ„">ç»“æ„</a>
          <ul>
            <li><a href="#serverçŠ¶æ€">serverçŠ¶æ€</a></li>
            <li><a href="#requestvote-rpc">RequestVote RPC</a></li>
            <li><a href="#appendentries-rpc">AppendEntries RPC</a></li>
            <li><a href="#rules-for-servers">rules for servers</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#lab2a-leaderé€‰ä¸¾">Lab2A: leaderé€‰ä¸¾</a></li>
    <li><a href="#lab2b-å®ç°raftä¹‹é—´çš„æ—¥å¿—å¤åˆ¶">Lab2B: å®ç°Raftä¹‹é—´çš„æ—¥å¿—å¤åˆ¶</a>
      <ul>
        <li><a href="#æ—¥å¿—åŒæ­¥è¦å¤„ç†çš„ç»“æ„å’Œæµç¨‹">æ—¥å¿—åŒæ­¥è¦å¤„ç†çš„ç»“æ„å’Œæµç¨‹</a></li>
        <li><a href="#æ³¨æ„çš„ç‚¹">æ³¨æ„çš„ç‚¹ï¼š</a>
          <ul>
            <li><a href="#ä¿è¯ä¸€è‡´æ€§">ä¿è¯ä¸€è‡´æ€§</a></li>
            <li><a href="#å¿ƒè·³æ—¶é—´å’Œé€‰ä¸¾æ—¶é—´">å¿ƒè·³æ—¶é—´å’Œé€‰ä¸¾æ—¶é—´</a></li>
            <li><a href="#åŒæ­¥">åŒæ­¥</a></li>
          </ul>
        </li>
        <li><a href="#bug">bug</a></li>
      </ul>
    </li>
    <li><a href="#lab2cpersistence">Lab2Cï¼špersistence</a></li>
  </ul>
</nav>
</div>
 


<script type="text/javascript" src="/js/toc.js" defer></script>




        

    </section>
    <section class="func">
        <div id="func-top" class="to-top">
            <a href="#top" target="_self">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 28 28" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    class="lucide lucide-arrow-big-up-dash">
                    <path d="M9 19h6" />
                    <path d="M9 15v-3H5l7-7 7 7h-4v3H9z" />
                </svg>
            </a>
        </div>

    </section>
</aside>
    <div class="content-container">
      <nav class="nav-container">
    <div class="nav-title">
        <a href="/" class="home-link" target="_blank">XUN</a>
    </div>
    <button type="button" class="drop-menu-button">
        <span class="menu-bar"></span>
        <span class="menu-bar"></span>
        <span class="menu-bar"></span>
    </button>
    <ul class="nav-menu-items"><li class="menu-item">
            <a href="/" target="_self">HOME</a>
        </li><li class="menu-item">
            <a href="/archive/" target="_self">ARCHIVE</a>
        </li><li class="menu-item">
            <a href="/notes/" target="_self">NOTES</a>
        </li><li class="menu-item">
            <a href="/about/" target="_self">ABOUT</a>
        </li>
    </ul>
 

</nav>
      <main class="content">
        <div class="page"><article class="post-block">
    <header class="post-header">
        <h1>ã€MIT 6.824ã€‘Lab2 Raft å®éªŒè®°å½•</h1>
        <div class="post-time">Jul 22 2022</div>
    </header>

    
    <div class="post-content"><p>ä¸‰ä¸ªå°å®éªŒï¼š<br>
A: å®ç°raftï¼šä¸€ä¸ªreplicated state machine protocol å¤åˆ¶çŠ¶æ€æœºåè®®<br>
B: å®ç°æ—¥å¿—ä¼ è¾“<br>
Cï¼šæŒä¹…åŒ–</p>
<p>build ä¸€ä¸ªå®¹é”™çš„keyvalue storageç³»ç»Ÿ raft åŠ¨ç”»ï¼š <a href="http://thesecretlivesofdata.com/raft/" target="_blank" rel="noopener">http://thesecretlivesofdata.com/raft/</a> <a href="https://www.jianshu.com/p/5aed73b288f7" target="_blank" rel="noopener">https://www.jianshu.com/p/5aed73b288f7</a></p>
<hr>
<h2 id="ç»“æ„å’Œæµç¨‹">ç»“æ„å’Œæµç¨‹ <a href="#%e7%bb%93%e6%9e%84%e5%92%8c%e6%b5%81%e7%a8%8b" style="border:none;"></a></h2><h3 id="çŠ¶æ€æœºé‚£å¼ å›¾">çŠ¶æ€æœºï¼š(é‚£å¼ å›¾) <a href="#%e7%8a%b6%e6%80%81%e6%9c%ba%e9%82%a3%e5%bc%a0%e5%9b%be" style="border:none;"></a></h3><p>raftç»´æŠ¤serveré›†ç¾¤ï¼Œæ¯ä¸ªé›†ç¾¤æœ‰ä¸‰ç§çŠ¶æ€ï¼šfollowerã€candidateã€leaderï¼Œä¸‰ç§çŠ¶æ€å¯ä»¥äº’ç›¸è½¬æ¢ï¼Œç›¸å½“äºä¸€ä¸ªçŠ¶æ€æœºã€‚</p>
<ul>
<li>followerï¼šæ¯ä¸ªsåˆå§‹åŒ–æ—¶éƒ½æ˜¯followerã€‚ -&gt; è¿›æ¥åï¼Œåœæ­¢å‘å¿ƒè·³ï¼ŒæŠ•ç¥¨ç½®-1ï¼Œé€‰ä¸¾å®šæ—¶reset å¦‚æœè¶…æ—¶-&gt; candidate</li>
<li>candidateï¼š -&gt; è¿›æ¥åå°±å¼€å§‹é€‰ä¸¾ å·²ç»æœ‰æ–°leaderæˆ–åˆ°æ–°term-&gt;follower; é€‰ä¸¾è¶…æ—¶-&gt; candidate; é€‰ä¸¾æˆåŠŸ-&gt; leader;</li>
<li>leader: -&gt; è¿›æ¥åå°±åœæ­¢è®¡æ—¶ï¼Œå¼€å§‹å¹¿æ’­ï¼Œé‡ç½®å¿ƒè·³è®¡æ—¶ å¦‚æœæœ‰æ›´é«˜çš„term-&gt; follower;</li>
</ul>
<h3 id="term">term: <a href="#term" style="border:none;"></a></h3><p>ä¸€ä¸ªä»»æœŸã€‚å’Œæ‹Ÿäººæ€çš„é€‰ä¸¾ä»»æœŸä¸€ä¸ªæ„æ€ã€‚</p>
<p>typeï¼š<br>
è¿™é‡Œtermæ˜¯ä¸ªæ•°å€¼ï¼Œè¡¨ç¤ºç¬¬å‡ ä»»ï¼Œæ¯ä¸ªserveréƒ½å­˜ç€å½“å‰çš„ä»»æœŸã€‚</p>
<p>æ›´æ–°æœºåˆ¶ï¼š<br>
å¦‚æœè¦é€‰æ–°leaderäº†ï¼Œå°±ä¼šterm+1ã€‚</p>
<p>æ¡ä»¶ï¼š<br>
æ¯ä¸ªä»»æœŸå†…åªèƒ½æœ‰ä¸€ä¸ªleader</p>
<p>æµç¨‹ï¼š<br>
ä¸€ä¸ªtermï¼š[term+1 -&gt; [é€‰ä¸¾time] -&gt; [æ­£å¸¸worktime]]<br>
æ•´ä¸ªç³»ç»Ÿï¼š[term1 -ä¸€äº›sæŒ‚-&gt; term2 -ä¸€äº›sæŒ‚-&gt; term3 -&gt;&hellip;]</p>
<h3 id="ç»“æ„">ç»“æ„ <a href="#%e7%bb%93%e6%9e%84" style="border:none;"></a></h3><p>å…³é”®çš„å›¾äºŒï¼š</p>
<h4 id="serverçŠ¶æ€">serverçŠ¶æ€ <a href="#server%e7%8a%b6%e6%80%81" style="border:none;"></a></h4><ul>
<li>
<p>serverçš„ç¨³å®šçŠ¶æ€ï¼š<br>
currentTermï¼š votedForï¼š(follower)ç»™candidatedIdæŠ•ç¥¨ï¼Œå¦‚æœæ²¡æœ‰å°±ç½®-1<br>
log[]ï¼šå­˜entry</p>
</li>
<li>
<p>serverçš„ä¸ç¨³å®šçŠ¶æ€ï¼š<br>
commitIndexï¼šå·²è¢«å¤§å¤šèŠ‚ç‚¹ä¿å­˜çš„ï¼ˆå·²commitçš„ï¼‰æœ€é«˜indexã€‚</p>
</li>
</ul>
<p>Leaderå½“å‰å·²ç»commitåˆ°äº†å“ªæ¡indexçš„LogEntry ä½•æ—¶commitï¼Ÿ</p>
<ul>
<li>å½“æ¯æ¬¡AppendEntriesæˆåŠŸä»¥åï¼Œæ£€æµ‹æŸä¸ªindexä½ç½®æ˜¯å¦æœ‰å¤šäºä¸€åŠçš„peersï¼Œå¦‚æœæ˜¯ï¼Œæ ‡è®°ä¸ºcommitã€‚<br>
æ³¨æ„ï¼Œè¿™é‡Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨matchIndexæ¥ä½œä¸ºæ£€æµ‹çš„æ‰‹æ®µï¼Œå› ä¸ºmatchIndexä»£è¡¨ç€ç‰¢é çš„ï¼Œå’ŒLeaderæ²¡æœ‰åˆ†æ­§çš„ä½ç½®ã€‚</li>
</ul>
<p>* <em>commitIndexæ˜¯ä¸åªæ˜¯Leaderçš„æ¦‚å¿µï¼Œé›†ç¾¤ä¸­æ‰€æœ‰èŠ‚ç‚¹çš„commitIndexåº”å½“ä¿æŒä¸€è‡´</em>ã€‚</p>
<p>lastAppliedï¼šæœ€åä¸€ä¸ªåº”ç”¨åˆ°çŠ¶æ€æœºçš„logçš„indexï¼Œåˆå§‹ä¸º0ã€‚å·²appliedçš„æœ€é«˜indexã€‚<br>
lastAppliedå’ŒcommitIndexç±»ä¼¼ï¼Œåœ¨æ ‡è®°å®ŒcommitIndexä»¥åï¼Œæˆ‘ä»¬è¦åšçš„å°±æ˜¯é€šè¿‡applyChåŒæ­¥applyæ¶ˆæ¯ï¼Œç„¶åå°†lastAppliedæ›´æ–°lastAppliedã€‚å› æ­¤ä»æŸç§ç¨‹åº¦æ¥è¯´ï¼Œåœ¨æˆ‘ä»¬Lab2ä¸­ï¼Œä¸¤è€…å‡ ä¹ç­‰æ•ˆã€‚åœ¨æ›´æ–°å®ŒcommitIndexä»¥åï¼Œé€šçŸ¥applyChï¼Œå†æ›´æ–°lastAppliedã€‚ lastAppliedä¸€å®šæ˜¯å°äºç­‰äºcommitIndex çš„ã€‚</p>
<p>leaderçš„ä¸ç¨³å®šçŠ¶æ€ï¼š<br>
matchIndex[]ï¼š leaderç”¨ï¼Œç”¨äºè¾…åŠ©è®¡ç®—commitIndexã€‚å®ƒè®°å½•çš„æ˜¯ç¡®å®šçš„å·²å’ŒLeaderåŒæ­¥çš„æœ€é«˜ä½ç½®ã€‚ï¼ˆä¹Ÿå¯ä»¥ç”¨å…¶å®ƒæ–¹å¼è®¡ç®—commitIndexï¼‰ æ¯ä¸ªséƒ½ä¿å­˜ä¸€ä»½ï¼Œå®ƒçš„indexæ˜¯æ¯ä¸ªsçš„idï¼Œé•¿åº¦æ˜¯å…±æœ‰sçš„ä¸ªæ•°ã€‚é‚£ä¹ˆmatchIndex[serverX]å°±è¡¨ç¤ºsXå’ŒleaderåŒæ­¥çš„æœ€é«˜ä½ç½®ã€‚ å¦‚æœæœ¬æœºå°±æ˜¯leaderï¼Œé‚£ä¹ˆå®ƒä¸€æ¥æ”¶cmdå°±è¡¨ç¤ºä¸è‡ªå·±åŒæ­¥äº†ï¼Œå°±æ›´æ–°matchIndexä¸ºlogçš„æœ€åä¸€æ ¼ï¼Œï¼ˆå½“å‰cmdå°±å­˜åœ¨logçš„æœ€åä¸€æ ¼ï¼‰ã€‚<br>
-&gt; å°±æ˜¯è¯´æ˜¯å·²å­˜å®Œï¼ˆä¸æ”¹ï¼‰çš„ä½ç½®ã€‚è¿™é‡Œè®¾ç½®Leaderè‡ªå·±çš„matchIndexçš„ç›®çš„ä¸»è¦æ˜¯æ–¹ä¾¿ç»Ÿè®¡æ˜¯å¦æœ‰å¤šäºä¸€åŠçš„peerså’ŒLeaderçš„log entryä¸€è‡´ï¼Œç„¶åè¿›è¡Œcommitï¼ˆå‚è€ƒcommitIndexï¼‰<br>
-&gt; å°±æ˜¯è¯´å°†è¦å­˜çš„ä½ç½® * prevLogIndexç”¨nextindex-1æ¥ç®—ï¼Œè€Œä¸æ˜¯matchindexæ¥ç®— * leaderçš„logsä¸ä¼šè·³ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥ç”¨é•¿åº¦è®¡ç®—</p>
<p>nextIndex[]ï¼š leaderç”¨ã€‚å’ŒmatchIndexç»“æ„ä¸€æ ·ã€‚ æ ‡è®°æ¯ä¸ªnodeç¼ºå¤±æ—¥å¿—çš„å¼€å§‹ä½ç½®ã€è¡¨ç°ä¸ºå³æ¯ä¸ªserverçš„logé•¿åº¦ã€‘ï¼Œå¯¹æ¯ä¸ªFollowerå‘èµ·AppendEntriesæ—¶è¯•replicated logå°±ä»è¿™é‡Œï¼ˆè¯·æ³¨æ„ï¼Œè¿™é‡Œè¯´çš„æ˜¯å°è¯•ï¼Œè¿™ä¸ªå€¼éœ€è¦è®¾ç½®çš„æ¯”è¯¥followerå¯¹åº”çš„matchIndexå¤§ï¼‰ã€‚åˆå§‹åŒ–ä¸ºlastlogindex+1ã€‚<br>
æ¯”å¦‚è¯´ s1ä¸ºleaderï¼ŒnextIndex[] = {9,6},é‚£ä¹ˆs2éœ€è¦åŒæ­¥çš„logå°±æ˜¯log[6] log[7] log[8] * nextIndex = matchIndex + 1</p>
<h4 id="requestvote-rpc">RequestVote RPC <a href="#requestvote-rpc" style="border:none;"></a></h4><p>argumentï¼š term candidateId lastLogIndex</p>
<p>lastLogTerm resultï¼š</p>
<p>termï¼šcurrentTerm</p>
<p>voteGrantedï¼šboolï¼Œtrueè¡¨ç¤ºcandidate æ¥æ”¶äº†æŠ•ç¥¨ receiver</p>
<p>implementationï¼š if (args.)term &lt; currentTerm: return False if voteFor == -1 or candidatedId and candidate.log is at least as up-to-date as receiver.</p>
<p>log: vote å¦‚æœä¸¤ä»½æ—¥å¿—æœ€åçš„æ¡ç›®çš„ä»»æœŸå·ä¸åŒï¼Œé‚£ä¹ˆä»»æœŸå·å¤§çš„æ—¥å¿—æ›´åŠ æ–°ï¼›å¦‚æœä¸¤ä»½æ—¥å¿—æœ€åçš„æ¡ç›®ä»»æœŸå·ç›¸åŒï¼Œé‚£ä¹ˆæ—¥å¿—æ¯”è¾ƒé•¿çš„é‚£ä¸ªå°±æ›´åŠ æ–°</p>
<h4 id="appendentries-rpc">AppendEntries RPC <a href="#appendentries-rpc" style="border:none;"></a></h4><p>argumentsï¼š</p>
<p>term: leaderçš„term</p>
<p>leaderId: prevLogIndex: æ–°çš„æ—¥å¿—æ¡ç›®ç´§éšä»¥å‰çš„ç´¢å¼•å€¼ã€‚ ç”¨nextindex-1æ¥ç®—ï¼Œè€Œä¸æ˜¯matchindexæ¥ç®—ï¼ˆwhyï¼Ÿï¼‰</p>
<p>prevLogTerm: prevLogIndex æ¡ç›®çš„ä»»æœŸå·</p>
<p>entries[]ï¼šå­˜è¦å¤åˆ¶ç»™followerçš„entriesã€‚<br>
entries = copy(leader.logs[nextindex:])</p>
<p>leaderCommitï¼šleaderçš„commitIndex</p>
<p>result: term success receiver implementation: if term &lt; currentTerm: return False if è‹¥æ˜¯æ—¥å¿—åœ¨ prevLogIndex ä½ç½®å¤„çš„æ—¥å¿—æ¡ç›®çš„ä»»æœŸå·å’Œ prevLogTerm ä¸åŒ¹é…ï¼š return False<br>
è‹¥æ˜¯ä¸¤ä¸ªæ—¥å¿—åœ¨ç›¸åŒçš„ç´¢å¼•ä½ç½®çš„æ—¥å¿—æ¡ç›®çš„ä»»æœŸå·ç›¸åŒï¼Œé‚£ä¹ˆå°±è®¤ä¸ºè¿™ä¸ªæ—¥å¿—ä»å¤´åˆ°è¿™ä¸ªç´¢å¼•ä½ç½®ä¹‹é—´æ‰€æœ‰å½»åº•ç›¸åŒ if ä¸€ä¸ªå·²å­˜çš„entryå’Œæ–°entryå†²çªï¼š deleteï¼ˆexisting entryï¼‰ for follower followed existing entryï¼š deleteï¼ˆfollowerï¼‰ if entry not in log: å°±æ˜¯è¯´åœ¨ğŸ‘†éƒ½ä¸å†²çªçš„æ¡ä»¶ä¸‹ï¼Œå¦‚æœç¼ºlogå°±å¼€å§‹å¤åˆ¶entry log.append(entry)<br>
if leaderCommit &gt; commitIndex: commitIndex = min(leaderCommit, index of last new entry)</p>
<h4 id="rules-for-servers">rules for servers <a href="#rules-for-servers" style="border:none;"></a></h4><p>all servers:</p>
<ul>
<li>if commitIndex &gt; lastApplied:<br>
lastApplied + 1<br>
apply log[lastApplied] to state machine</li>
<li>if RPC request or response contains term T &gt; currentTerm:<br>
currentTerm = T<br>
end(currentTerm) to follower</li>
</ul>
<p>followers:<br>
response to RPCs from candidates and leaders<br>
if election timeout elapses without receiving<br>
AppendEntries RPC from current leader or granting vote to candidate: convert to candidate candidates: on conversion to candidateï¼Œå¼€å§‹é€‰ä¸¾ï¼š currentTerm+1 vote for self reset election timer send requestvote rpcs to all other servers if votes &gt; numofsesrvers//2 +1: become leader<br>
if appendEntries RPC received from new leader: convert to follower<br>
if election timeout<br>
elapses: å¼€å§‹é€‰ä¸¾<br>
leaderï¼š upon<br>
electionï¼š send initial empty appendentries RPCs(heartbeat) to each server repeat during idle periods to prevent election timeouts æ›´æ–°æ‰€æœ‰follower nextIndex=len(rf.logs) + 1<br>
if command received from client:<br>
log.append(entry) respond after entry applied to state machine<br>
if last log index &gt;= nextIndex for a follower:      <br>
send AppendEntries RPC with log entires staring at nextIndex<br>
if success:<br>
è¯´æ˜å·²ç»æˆåŠŸåœ¨followerä¸Šreplicatedäº†log<br>
æ›´æ–°nextIndexï¼Œæ›´æ–°matchIndexåˆ°æœ€æ–°ä½ç½® u<br>
pdate nextIndex &amp; matchIndex for follower<br>
if fail: è¯´æ˜ç°åœ¨çš„nextIndexå¤ªå¤§ï¼ŒnextIndex = nextIndex - 1å†æ¬¡å°è¯•AppendEntries<br>
if N and N &gt; commitIndex, a majority of matchIndex[i] &gt;= N and log[N].term == currentTerm:<br>
commitIndex = N</p>
<h2 id="lab2a-leaderé€‰ä¸¾">Lab2A: leaderé€‰ä¸¾ <a href="#lab2a-leader%e9%80%89%e4%b8%be" style="border:none;"></a></h2><p>å®ç°é€‰ä¸¾å•ä¸ªé¢†å¯¼è€…ã€‚<br>
å‘é€æ¥æ”¶é€‰ä¸¾reqçš„rpcï¼Œé€‰ä¸¾çš„è§„åˆ™ï¼Œleaderçš„çŠ¶æ€ã€‚</p>
<pre tabindex="0"><code>go test -run 2A -race
</code></pre><p>2Aæµ‹è¯•ä¸‰ä¸ªï¼š</p>
<ol>
<li>TestInitialElection2A æµ‹åœ¨æ­£å¸¸è¿è¡ŒçŠ¶æ€ä¸‹leaderæ˜¯å¦ä¿æŒç¨³å®š</li>
<li>TestReElection2A æµ‹åœ¨æœ‰serveræŒ‚æ—¶ï¼Œæ˜¯å¦å¯ä»¥æ­£ç¡®é€‰å‡ºleader
<ul>
<li>æ—§leaderåŠ å…¥ä¸å½±å“æ–°leader</li>
<li>è¾¾åˆ°æ³•å®šäººæ•°ï¼Œé€‰å‡ºä¸€ä¸ªleaderï¼›å°‘äºæ³•å®šäººæ•°ï¼Œåº”è¯¥æ²¡æœ‰leader</li>
</ul>
</li>
<li>TestManyElections2A æµ‹å¤šæ¬¡é€‰ä¸¾æ˜¯å¦å¯ä»¥æ­£ç¡®é€‰å‡ºleader<br>
å¼€7ä¸ªèŠ‚ç‚¹ï¼ŒéšæœºæŒ‚3ä¸ªï¼Œè¦æ±‚è¦ä¹ˆleaderä»ç„¶åœ¨ï¼Œè¦ä¹ˆåœ¨4ä¸ªèŠ‚ç‚¹é‡Œé€‰ä¸€ä¸ªleader</li>
</ol>
<p>æµ‹è¯•è¦æ±‚ï¼š</p>
<ul>
<li>leaderæ¯ç§’å‘é€å¿ƒè·³RPCä¸è¶…è¿‡åæ¬¡</li>
<li>æ¯ä¸ªpeeré‡ç½®çš„timeoutè¦ä¸ä¸€æ ·ï¼Œä»¥é˜²æ— é™loopé€‰ä¸¾</li>
<li>timeoutè¦è¶³å¤ŸçŸ­ã€‚å³ä½¿å¯èƒ½æœ‰å¤šè½®ï¼Œé€‰ä¸¾éƒ½è¦5ç§’å†…ç»“æŸï¼ˆä»ä¸Šæ¬¡æ—§leaderå¤±æ•ˆå¼€å§‹ç®—ï¼‰ã€‚æ¯”paperé‡Œçš„150ms-300msé•¿</li>
</ul>
<p>æµ‹è¯•ç»™å®šserverä¸ªæ•°ï¼Œé€šè¿‡cfg=make_configåˆå§‹åŒ–æ•´ä¸ªç³»ç»Ÿã€‚<br>
åœ¨make_configé‡Œéå†serverä¸ªæ•°ï¼Œåˆå§‹åŒ–æ¯ä¸ªserverçš„logï¼Œå¹¶é€šè¿‡start1å¯åŠ¨è¯¥serverã€‚<br>
start1:</p>
<ul>
<li>å‚æ•°ï¼š<br>
å½“å‰serviceçš„index<br>
applieræ˜¯ä¸ªå‡½æ•°ï¼Œåç¨‹goå‘é€ï¼Œä»apply chæ‹¿messageï¼Œçœ‹æ˜¯å¦å’Œlogå†…å®¹match</li>
<li>åœ¨start1é‡Œç”¨Make()åˆå§‹åŒ–æ¯ä¸ªserverï¼š
<ul>
<li>Makeçš„å‚æ•°ï¼š
<ul>
<li>peersï¼šæœåŠ¡å™¨ä»¬</li>
<li>meï¼šæœ¬serverid<br>
é™¤äº†ç»™serverèµ‹å€¼ä¹‹å¤–ï¼Œæ¯ä¸ªserverè¿˜ä¼šåœ¨è¿™é‡Œèµ·çº¿ç¨‹<br>
çº¿ç¨‹tickerï¼šè½®è¯¢çœ‹æœ¬serveræœ‰æ²¡æœ‰æ¥ä¸åˆ°æ¶ˆæ¯ï¼Œè¦ä¸è¦é€‰ä¸¾ã€‚å¦‚æœè¦ï¼Œæœ¬èŠ‚ç‚¹å°±å˜æˆcandidï¼Œå¹¶å‘æŠ•ç¥¨ã€‚<br>
çº¿ç¨‹applier</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>æ‰€ä»¥æ˜¯æ¯ä¸€ä¸ªserveré‡Œéƒ½å­˜äº†å…¨å¥—çš„logsã€nextIndexå’ŒmatchIndex</p>
<p>é€‰ä¸¾çš„ç»“æ„å’Œæµç¨‹ï¼š</p>
<ul>
<li>æ‰€æœ‰çŠ¶æ€é€šè¿‡raftç»“æ„ä½“ç®¡ç†ï¼Œraft structæ˜¯ä¸€ä¸ªæ•´ä½“çš„</li>
<li>ä¸€å˜æˆè¯¥çŠ¶æ€ï¼ˆè°ƒç”¨transStatusï¼‰å°±å¼€å§‹è¿™æ ·åšï¼šleaderè´Ÿè´£å‘é€å¿ƒè·³å¹¿æ’­ï¼Œfollowerè´Ÿè´£é€‰ä¸¾è®¡æ—¶ã€ç»™åˆ«äººæŠ•ç¥¨ï¼Œcandidateè´Ÿè´£å‘èµ·æŠ•ç¥¨ã€‚</li>
<li>å…¶ä¸­å‘é€å¹¿æ’­æ˜¯ä¸€ä¸ªä¸åœå¾ªç¯çš„çº¿ç¨‹ï¼Œé‚£ä¹ˆå°±éœ€è¦èµ·ä¸€ä¸ªgo</li>
<li>é€‰ä¸¾è®¡æ—¶æ˜¯æ¯ä¸ªserveréƒ½holdæœ‰è‡ªå·±çš„è®¡æ—¶å™¨ï¼Œæ‰€ä»¥æ˜¯ä¸€ä¸ªå±æ€§ï¼Œä¸€å˜æˆfollowerå°±reset</li>
<li>å‘èµ·æŠ•ç¥¨æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œcandéå†æ¯ä¸ªserverï¼Œç»™æ¯ä¸ªfolloweréƒ½å‘é€æŠ•ç¥¨å‡½æ•°</li>
<li>æŠ•ç¥¨å‡½æ•°RequestVoteï¼šè¢«è¦æ±‚æŠ•ç¥¨çš„follower.requestVote(args:è¦æ±‚æŠ•å®ƒçš„cand, reply:è¦ä¸è¦æŠ•)</li>
</ul>
<p>bugï¼š</p>
<ul>
<li>
<p>expected no leader among connected servers, but 0 claims to be leader:<br>
-&gt; getState()çš„æ—¶å€™è¦åŠ é”</p>
</li>
<li>
<p>æœ¬æ¥å·²ç»term4äº†ï¼Œåˆå›åˆ°term3ä¸”åˆä¸¤ä¸ªleader:<br>
-&gt; å¦‚æœæœ¬è½®å·²ç»æŠ•è¿‡ç¥¨äº†ï¼Œå°±ä¸åº”è¯¥å†æŠ•äº†<br>
ï¼ˆleaderçš„voteForæ²¡æœ‰æ›´æ–°ï¼Œä¸€ç›´æ˜¯å®ƒè‡ªå·±ï¼Œæ‰€ä»¥leaderä¸ä¼šç»™åˆ«äººæŠ•ç¥¨çš„ï¼Œåªæœ‰å˜æˆfollowerçš„äººæ‰ä¼šæ›´æ–°voteForä¸º-1ï¼Œå·§å¦™ï¼‰<br>
B:æ•°æ®åŒæ­¥</p>
</li>
</ul>
<h2 id="lab2b-å®ç°raftä¹‹é—´çš„æ—¥å¿—å¤åˆ¶">Lab2B: å®ç°Raftä¹‹é—´çš„æ—¥å¿—å¤åˆ¶ <a href="#lab2b-%e5%ae%9e%e7%8e%b0raft%e4%b9%8b%e9%97%b4%e7%9a%84%e6%97%a5%e5%bf%97%e5%a4%8d%e5%88%b6" style="border:none;"></a></h2><p>å®ç°AppendEntries RPCä»¥åŠå‘é€AppendEntries RPCçš„æ–¹æ³•HandleAppendEntriesã€‚</p>
<pre tabindex="0"><code>go test -run 2B -race
</code></pre><p>2Bæµ‹è¯•10ä¸ªï¼š<br>
â‘  TestBasicAgree2B<br>
Start()è¿è¡Œä¹‹å‰ï¼Œä¸èƒ½æœ‰æäº¤çš„logå­˜åœ¨<br>
â‘¡ TestRPCBytes2B<br>
åŸºäºRPCçš„å­—èŠ‚æ•°æ£€æŸ¥ä¿è¯æ¯ä¸ªcmdéƒ½åªå¯¹æ¯ä¸ªpeerå‘é€ä¸€æ¬¡ã€‚<br>
â‘¢ For2023TestFollowerFailure2B<br>
â‘£ For2023TestLeaderFailure2B<br>
â‘¤ TestFailAgree2B<br>
æ–­è¿å°éƒ¨åˆ†ï¼Œä¸å½±å“æ•´ä½“Rafté›†ç¾¤çš„æƒ…å†µæ£€æµ‹è¿½åŠ æ—¥å¿—ã€‚<br>
â‘¥ TestFailNoAgree2B<br>
æ–­è¿è¿‡åŠæ•°èŠ‚ç‚¹ï¼Œä¿è¯æ— æ—¥å¿—å¯ä»¥æ­£å¸¸è¿½åŠ ã€‚ç„¶ååˆé‡æ–°æ¢å¤èŠ‚ç‚¹ï¼Œæ£€æµ‹è¿½åŠ æ—¥å¿—æƒ…å†µã€‚<br>
â‘¦ TestConcurrentStarts2B<br>
æ¨¡æ‹Ÿå®¢æˆ·ç«¯å¹¶å‘å‘é€å¤šä¸ªå‘½ä»¤<br>
â‘§ TestRejoin2B<br>
Leader 1æ–­è¿ï¼Œå†è®©æ—§leader 1æ¥å—æ—¥å¿—ï¼Œå†ç»™æ–°Leader 2å‘é€æ—¥å¿—ï¼Œ2æ–­è¿ï¼Œå†é‡è¿æ—§Leader 1ï¼Œæäº¤æ—¥å¿—ï¼Œå†è®©2é‡è¿ï¼Œå†æäº¤æ—¥å¿—ã€‚<br>
â‘¨ TestBackup2B<br>
å…ˆç»™Leader 1å‘é€æ—¥å¿—ï¼Œç„¶åæ–­è¿3ä¸ªFollowerï¼ˆæ€»å…±1Ledaer 4Followerï¼‰ï¼Œç½‘ç»œåˆ†åŒºã€‚æäº¤å¤§é‡å‘½ä»¤ç»™1ã€‚ç„¶åè®©leader 1å’Œå…¶Followerä¸‹çº¿ï¼Œä¹‹å‰çš„3ä¸ªFollowerä¸Šçº¿ï¼Œå‘å®ƒä»¬å‘é€æ—¥å¿—ã€‚ç„¶ååœ¨å¯¹å‰©ä¸‹çš„ä»…æœ‰3ä¸ªèŠ‚ç‚¹çš„Rafté›†ç¾¤é‡å¤ä¸Šé¢ç½‘ç»œåˆ†åŒºçš„è¿‡ç¨‹ã€‚<br>
â‘© TestCount2B<br>
æ£€æŸ¥æ— æ•ˆçš„RPCä¸ªæ•°ï¼Œä¸èƒ½è¿‡å¤šã€‚</p>
<p>æ³¨æ„ï¼š</p>
<ul>
<li>å¦‚æœè·‘çš„å¤ªæ…¢å¯èƒ½ä¼šæŒ‚</li>
<li>åœ¨æ—©æœŸçš„ Lab 2B æµ‹è¯•ä¸­æœªèƒ½è¾¾æˆåè®®çš„ä¸€ç§æ–¹æ³•æ˜¯ï¼Œå³ä½¿é¢†å¯¼è€…è¿˜æ´»ç€ï¼Œä¹Ÿè¦è¿›è¡Œé‡å¤é€‰ä¸¾ã€‚?</li>
<li>è¦åœ¨loopé‡ŒåŠ å…¥time.Sleep(10 * time.Millisecond)ï¼Œä»¥å…ææ…¢å®ƒä»¥è‡³äºå‡ºbug</li>
</ul>
<h3 id="æ—¥å¿—åŒæ­¥è¦å¤„ç†çš„ç»“æ„å’Œæµç¨‹">æ—¥å¿—åŒæ­¥è¦å¤„ç†çš„ç»“æ„å’Œæµç¨‹ <a href="#%e6%97%a5%e5%bf%97%e5%90%8c%e6%ad%a5%e8%a6%81%e5%a4%84%e7%90%86%e7%9a%84%e7%bb%93%e6%9e%84%e5%92%8c%e6%b5%81%e7%a8%8b" style="border:none;"></a></h3><ul>
<li>
<p>start() å¦‚æœæ˜¯leaderï¼Œå°±start leaderã€‚<br>
startæ—¶å°†ï¼ˆclientï¼‰ç»™çš„cmdä¼ ç»™leaderï¼Œè®°åœ¨leaderçš„logé‡Œã€‚<br>
è¦è¿”å›è¿™ä¸€è½®å„¿ä»logçš„å“ªé‡Œï¼ˆindexï¼‰å¼€å§‹ã€‚è¿™ä¸ªå¼€å§‹çš„indexï¼Œå°±æ˜¯åˆšåˆšè¿™ä¸ªcmdå­˜åˆ°çš„indexã€‚ å°±æ˜¯å½“å‰logçš„æœ€åä¸€ä¸ªï¼Œå³len(logs) - 1ã€‚<br>
åŒæ—¶å‘¢ï¼Œå°†è¿™ä¸ªindexæ›´æ–°åœ¨matchIndex[æœ¬æœºid]ä¸Šã€‚<br>
æ³¨æ„å½“è½¬æ¢çŠ¶æ€è‡³leaderçš„æ—¶å€™ï¼Œä¹Ÿè¦æ›´æ–°nextIndexå’ŒmatchIndexã€‚</p>
</li>
<li>
<p>broadcastHeartbeatï¼š</p>
<ul>
<li>åªè¦å½“ä¸Šäº†leaderï¼Œå°±ç»™æ¯ä¸ªäººå‘å¹¿æ’­ã€‚for peers/serveréå†ï¼Œgoä¸€ä¸ªå‘é€å¿ƒè·³çš„çº¿ç¨‹ã€‚<br>
å¯¹æ¯ä¸ªpeeræ¥è¯´ï¼Œä¼šå‘é€appendEntriesæ¥ä¼ é€’ä¿¡æ¯ã€‚</li>
<li>éœ€è¦ä¼ é€’çš„ï¼š
<ul>
<li>æœ¬leaderçš„termå’Œidï¼šçœ‹çœ‹æ­¤leaderæœ‰æ— èµ„æ ¼copyï¼›</li>
<li>prevlogindexå’Œprevlogtermï¼Œå°±æ˜¯æœ¬leaderè¿™é‡Œè®°å½•çš„è¦copyçš„followerçš„è¦è®°å½•çš„èµ·ç‚¹å’Œtermï¼šçœ‹çœ‹èƒ½ä¸èƒ½ç›´æ¥copyï¼›</li>
<li>æœ¬leaderçš„commitidï¼Œçœ‹çœ‹èƒ½ä¸èƒ½æäº¤ï¼›</li>
<li>æ•´ä¸ªlogentriesçš„å‰¯æœ¬ã€‚</li>
</ul>
</li>
<li>å¦‚æœæˆåŠŸäº†ï¼ˆå³ä¸å‘é€æ•°æ®ï¼Œæˆ–è€…æ•°æ®å…¨éƒ½æˆåŠŸcopyäº†ï¼‰ï¼š
<ol>
<li>å…ˆæ›´æ–°nextIndex/matchIndexã€‚nextIndexè¿½åŠ æ‹·è´è¿‡å»entriesçš„ä¸ªæ•° += len(args.LogEntries)ï¼›matchIndexä¸ºnextIndex - 1ï¼ˆæˆ–ä¸ºä¹‹å‰matchIndex+ copyè¿‡entriesçš„ä¸ªæ•° args.prevLogIndex + len(args.LogEntries)ï¼‰</li>
<li>å€’ç€éå†ï¼ˆåªè¦i commitäº†ï¼Œæ¯”iå°çš„å°±éƒ½commitäº†ä¸ç”¨å†éå†ï¼‰å½“å‰çš„logs indexï¼Œåˆ°commitIndexä¸ºæ­¢ï¼šç»Ÿè®¡å¦‚æœï¼ˆlen(peers)/2ï¼‰çš„serveréƒ½æˆåŠŸcopyäº†ï¼Œå°±æŠŠè¿™ä¸ªindexçš„è®¾æˆcommitã€‚<br>
å¦‚ä½•ç»Ÿè®¡å‘¢ï¼Œçœ‹matchindexã€‚å¦‚æœsXæˆåŠŸcopyäº†ç¬¬indexä¸ªentryï¼Œå°±è¡¨ç¤ºmatchindex[sX]çš„å€¼å°±åº”è¯¥&gt;=index,(means å­˜äº†æ›´å¤šï¼Œé‚£ä¹ˆindexä¸€å®šä¹Ÿå­˜äº†)</li>
</ol>
</li>
<li>å¦‚æœå¤±è´¥äº†ï¼š<br>
å¦‚æœé‚£ä¸ªfollowerçš„termæ¯”æœ¬leaderé«˜ï¼Œæœ¬leaderå°±å°†ä¸ºfollowerã€‚<br>
å¦åˆ™ï¼š<br>
æœ¬leaderå°±æŠŠnextIndexé€€ä¸€ä½ï¼ˆå¤±è´¥æ˜¯å› ä¸ºæ‰“ç®—copyçš„ä½ç½®å¤ªæ¿€è¿›å¤ªæ–°äº†ï¼‰ï¼Œå†è¯•ä¸€æ¬¡<br>
-&gt; ä¼˜åŒ–ï¼šå¯ä»¥åœ¨åŒæ­¥çš„æ—¶å€™è®°å½•å†²çªçš„ä½ç½®ï¼Œè¿™é‡Œå°±å¯ä»¥ç›´æ¥é€€åˆ°å†²çªçš„ä½ç½®å†è¯•ï¼Œä¸ç”¨ä¸€æ­¥ä¸€æ­¥é€€ã€‚</li>
</ul>
</li>
<li>
<p>AppendEntries Rpc<br>
leaderé€šè¿‡è¿™ä¸ªå‡½æ•°æ¥ä¼ æ¶ˆæ¯ç»™followerã€‚å¦‚æœæ²¡æ•°æ®åŒæ­¥ï¼Œå°±æ˜¯å¿ƒè·³åŒ…ã€‚å¦‚æœæœ‰æ•°æ®åŒæ­¥ï¼ŒRpcä¸­ä¼šæºå¸¦éœ€è¦åŒæ­¥çš„å†…å®¹(LogEntry)<br>
åŒæ­¥çš„æ¡ä»¶ï¼š</p>
<ol>
<li>
<p>åˆ¤æ–­ä»»æœŸï¼š<br>
å¦‚æœå½“å‰ï¼ˆleaderï¼‰å‘é€æ¥çš„term &lt; æœ¬æœºçš„termï¼Œå°±ä¸å¤„ç†</p>
</li>
<li>
<p>åˆ¤æ–­æ˜¯å¦æ¥æ”¶æ•°æ®ï¼šsuccessè¡¨ç¤ºæ•°æ®å…¨æ¥æ”¶ï¼Œoræœ¬è½®ä¸åŒæ­¥æ•°æ®<br>
å› ä¸ºä¼šæœ‰bugçš„æƒ…å†µï¼šå½“é›†ç¾¤å…±åŒå­˜ï¼ˆcommitï¼‰äº†123åï¼Œåˆ†è£‚æˆä¸¤ç»„ï¼Œä¸€ç»„term1ï¼Œæ›´æ–°çš„æ•°æ®æ˜¯5ï¼Œå³å½“å‰å­˜çš„æ˜¯1235ï¼›ä¸€ç»„term2ï¼Œæ›´æ–°äº†8ï¼Œå³å½“å‰å­˜çš„æ•°æ®æ˜¯1238ï¼›ä½†æ˜¯term2ä¸å¤Ÿ&gt;len/2+1,æ‰€ä»¥5ä¸€ç›´æ˜¯æœªæäº¤ã€‚è¿™æ—¶term1ç»™term2çš„serverä¼ äº†è¿™ä¸ª8ï¼Œterm2çš„serverå°±è¦å›æ»šæ‰5ï¼Œæ›´æ–°æˆ1238ã€‚<br>
æ‰€ä»¥å‘¢ï¼Œå¦‚æœè¦åŒæ­¥ï¼Œéœ€è¦è¿™äº›ä¿¡æ¯ï¼š</p>
<ul>
<li>ï¼ˆæ¯æœºéƒ½éœ€è¦ï¼‰å­˜entryçš„åœ°æ–¹ï¼šlogs[LogEntry]</li>
<li>éœ€è¦è¢«å¤åˆ¶çš„entriesï¼šargs.entries</li>
<li>æœ¬æœºå½“å‰ç¼ºå¤±çš„æœ€æ—©çš„indexï¼šlen(rf.logs)<br>
* <em>æ›´æ–°çš„å®šä¹‰æ˜¯ï¼Œå¦‚æœtermæ›´é«˜å°±æ›´æ–°ï¼Œå¦‚æœtermä¸€æ ·ï¼Œå°±çœ‹è°çš„logæ›´é•¿å°±æ›´æ–°</em>ã€‚</li>
</ul>
</li>
<li>
<p>åˆ¤æ–­æ˜¯å¦æäº¤æ•°æ®ï¼š<br>
å¦‚æœæœ¬æœºçš„commitIndexå°äºleaderçš„commitIndexï¼Œå°±å¯ä»¥æ›´æ–°commitIndexï¼Œè®¾ç½®commitIndex = min(leaderCommit, æœ€æ–°entryåœ¨çš„index)ï¼Œç„¶åå‘é€å‘½ä»¤åˆ°ApplyChï¼Œè¡¨ç¤ºå¯ä»¥åº”ç”¨äº†ã€‚</p>
<p>ä¸ºç”šä¹ˆè¦minï¼š<br>
å› ä¸ºæœ‰å¯èƒ½leaderå‘ç»™followerçš„max indexä¹Ÿæ¯”å½“å‰leaderçš„commitindexå°ï¼Œå¦‚æœç›´æ¥æ›´æ–°åˆ°commitindexï¼Œfollowerçš„logä¸­é—´å°±æœ‰ä¸€äº›ç©ºæŒ¡ã€‚</p>
</li>
</ol>
</li>
<li>
<p>commitæäº¤ã€‚<br>
æ²¡æäº¤æ„æ€å°±æ˜¯clientåªç»™leaderå‘äº†entriesï¼Œleaderè¿˜æ²¡ç»™followeråŒæ­¥è¿™äº›entriesã€‚<br>
æäº¤äº†çš„æ„æ€å°±æ˜¯ï¼Œå¦‚æœå°†æ¥æœ‰ä»€ä¹ˆbugéœ€è¦å›æ»šæ•°æ®ï¼Œä¹Ÿåªèƒ½å›æ»šåˆ°æœªæäº¤çš„ï¼Œå·²æäº¤çš„æ•°æ®å°±ä¸èƒ½è¢«é‡å†™äº†ã€‚<br>
commitçš„æ­¥éª¤ï¼šLog Replication</p>
<ol>
<li>leaderæŠŠè¿™äº›entriesï¼ˆå‰¯æœ¬ï¼‰ä¼ ç»™follower</li>
<li>followerä¼šè¿”å›ç»™leaderå®ƒæœ‰æ²¡æœ‰å†™å¥½ã€‚</li>
<li>å¦‚æœlen/2+1çš„äººéƒ½å†™å¥½äº†ï¼Œå°±ç®—commitäº†ã€‚</li>
<li>leaderå†å‘é€ç»™followerï¼Œé€šçŸ¥è¯¥entrieså·²commit</li>
<li>è¾¾æˆäº†å…±è¯†ï¼ˆleaderå°±å¯ä»¥returnç»™clientäº†ï¼‰</li>
</ol>
<p>commitå’Œapplyï¼š<br>
å‡å¦‚å½“å‰è®°å½•äº†commitIndexï¼Œä½†æ­¤æ—¶èŠ‚ç‚¹å´©æºƒäº†ï¼Œé‚£ä¹ˆå·²æäº¤çš„æ—¥å¿—æ¡ç›®å°±å¹¶æ²¡æœ‰çœŸæ­£çš„åº”ç”¨åˆ°çŠ¶æ€æœºä¸­ï¼Œæ‰€ä»¥éœ€è¦appliedè¿™ä¸ªå±æ€§è®°å½•çœŸå®åº”ç”¨åˆ°çŠ¶æ€æœºçš„æ—¥å¿—åˆ°å“ªé‡Œäº†ã€‚<br>
commitIndexè¡¨ç¤ºæœ€åä¸€ä¸ªçŠ¶æ€ä¸ºCommitçš„indexï¼›lastAppliedè¡¨ç¤ºæœ€åä¸€ä¸ªçŠ¶æ€ä¸ºAppliedçš„index</p>
<ul>
<li>
<p>ä¸€ä¸ªentryè¢«å¤§å¤šæ•°serverå¤åˆ¶åˆ°äº†log</p>
</li>
<li>
<p>æŒ‡ä»¤æ˜¯æŒ‰é¡ºåºè¿½åŠ çš„ï¼Œä¸€ä¸ªentryæ˜¯commitedï¼Œé‚£ä¹ˆä¹‹å‰æ‰€æœ‰entryéƒ½æ˜¯commited</p>
</li>
<li>
<p>ä¸€æ—¦followerç¡®è®¤ä¸€ä¸ªentryæ˜¯commitedï¼Œä»–å°†åœ¨è‡ªå·±çš„çŠ¶æ€æœºæ‰§è¡Œæ­¤entry</p>
</li>
<li>
<p>ç”±äºåªæœ‰Appliedåªèƒ½ç”±Commitè½¬æ¢è€Œæ¥ï¼Œæ‰€ä»¥lastApplied &lt;= commitIndexä¸€å®šæˆç«‹<br>
åªæœ‰å½“commitè¿‡çš„entriesæ‰ä¼šapplyã€‚å½“commitIndexå¤§äºlastAppliedçš„æ—¶å€™ï¼Œè‡ªå¢lastApplied,ç„¶åå°†æ—¥å¿—åº”ç”¨åˆ°çŠ¶æ€æœºä¸Šã€‚æ‰§è¡Œï¼š</p>
<ul>
<li>å¸‚é¢ä¸Šæœ‰ä¸¤ç§å®ç°ï¼Œä¸€ç§æ˜¯å°†applyæ”¾åœ¨ä¸»å‡½æ•°Makeé‡Œé¢å•å¼€çº¿ç¨‹è¿è¡Œï¼Œè¿™ç§ç”¨condï¼›ä¸€ç§æ˜¯å°†applyæ”¾åœ¨setcommitå‡½æ•°é‡Œé¢ï¼Œå¦‚æœæœ‰commitçš„åŠ¨ä½œæ‰å¼€applyã€‚</li>
</ul>
<p>è¿™é‡Œç”¨setcommitï¼šè®°å½•ä¸Šæ¬¡appliedindexï¼Œ+1ä¸ºæ–°applyå¼€å§‹çš„åœ°æ–¹ä¸ºstartIdxï¼›è¦applyçš„ï¼Œåˆ°commiteè¿‡çš„entryçš„ä½ç½®ä½ç½®ï¼Œæ‰€ä»¥åˆè®°å½•entries=[lastapplied+1:commited+1],ä½œä¸ºè¦applyçš„æ‰€æœ‰entryã€‚<br>
ç„¶åå°†msgé€šè¿‡chanä¼ ç»™rf.appleChã€‚<br>
ç„¶åæ›´æ–°rfçš„lastAppliedï¼Œä¸ºmax(lastApplied, startIdx+è¦applyçš„ä¸ªæ•°)<br>
ï¼ˆï¼Ÿè¿™é‡Œ æœ‰ç–‘é—®ä¸ºç”šä¹ˆè¦åœ¨å¾ªç¯é‡Œé¢æ›´æ–°lastAppliedï¼‰</p>
</li>
</ul>
</li>
<li>
<p>ä¿®æ”¹RequestVote<br>
åœ¨labAé‡Œé¢ï¼Œç¬¬ä¸€ä¸ªæ¥è¦ç¥¨çš„äººï¼Œfollowerå°±ä¼šæŠ•ç»™å®ƒã€‚è¿™é‡Œéœ€è¦updateçš„æ˜¯ï¼šå¦‚æœæœ‰ä¸€ä¸ªlogså¾ˆçŸ­çš„serverå½“äº†nodeï¼Œå®ƒè¦ç»™åˆ«äººåŒæ­¥çš„è¯ï¼Œåˆ«çš„serveré‡Œæ¯”å®ƒå¤šçš„entryå°±éƒ½ä¼šä¸¢å¤±ã€‚<br>
æ‰€ä»¥æŠ•ç¥¨æ—¶ï¼Œè¯¥followeréœ€è¦éªŒè¯ï¼Œleaderçš„logé•¿åº¦ä¸èƒ½çŸ­è¿‡è‡ªå·±ï¼Œæœ€åä¸€ä¸ªlogçš„termã€ä¸èƒ½æ¯”æœ¬æœºå°ã€‘ï¼Œæ‰€ä»¥éœ€è¦å‚æ•°ï¼š<br>
leaderçš„æœ€åä¸€ä¸ªlogçš„indexï¼šargs.LastLogIndex &lt;â€”â€” len(leader.logs) - 1<br>
leaderçš„æœ€åä¸€ä¸ªlogçš„termï¼šargs.LastLogTerm &lt;â€”â€” leader.logs[-1].Term<br>
æœ¬æœºçš„æœ€åä¸€ä¸ªlogçš„indexï¼šlen(rf.logs) - 1<br>
æœ¬æœºçš„æœ€åä¸€ä¸ªlogçš„termï¼šrf.logs[-1].Term</p>
</li>
</ul>
<h3 id="æ³¨æ„çš„ç‚¹">æ³¨æ„çš„ç‚¹ï¼š <a href="#%e6%b3%a8%e6%84%8f%e7%9a%84%e7%82%b9" style="border:none;"></a></h3><h4 id="ä¿è¯ä¸€è‡´æ€§">ä¿è¯ä¸€è‡´æ€§ <a href="#%e4%bf%9d%e8%af%81%e4%b8%80%e8%87%b4%e6%80%a7" style="border:none;"></a></h4><p>æ•´ä¸ªå¤åˆ¶çš„è¿‡ç¨‹ï¼Œå¾ˆé‡è¦çš„ä¸€ç‚¹å°±æ˜¯è¦ä¿è¯ç®—æ³•çš„ä¸€è‡´æ€§ã€‚<br>
å¦‚ä½•ä¿è¯ä¸€è‡´æ€§ï¼š</p>
<ol>
<li>
<p>æ•°æ®ä¸ä¸€è‡´çš„åˆ¤å®šæ ‡å‡†ï¼š<br>
â‘  leaderæœ€å¤šåœ¨ä¸€ä¸ªtermé‡Œåœ¨æŒ‡å®šçš„ä¸€ä¸ªæ—¥å¿—ç´¢å¼•ä½ç½®å»ºç«‹ä¸€æ¡æ—¥å¿—æ¡ç›®ï¼ŒåŒæ—¶æ—¥å¿—æ¡ç›®åœ¨æ—¥å¿—ä¸­çš„ä½ç½®ä¹Ÿä¸ä¼šæ”¹å˜ã€‚<br>
â€”&gt;ï¼Œé‚£ä¹ˆï¼Œå¦‚æœä¸¤ä¸ªæ—¥å¿—åœ¨ç›¸åŒç´¢å¼•çš„ä½ç½®çš„Termç›¸åŒï¼Œé‚£ä¹ˆä»å¼€å§‹åˆ°è¯¥ç´¢å¼•ä½ç½®çš„æ—¥å¿—ä¸€å®šç›¸åŒï¼š<br>
å½“Leader.log[N-1].Term == Follower.log[N-1].Termæ—¶ï¼šå°±å¯ä»¥æŠŠLeader.log[N]åŒæ­¥åˆ°Followerï¼ŒF.log[N] = L.log[N]<br>
â€”&gt; é‚£ä¹ˆå°±å¾ˆå¥½åˆ¤å®šï¼šåªè¦ å¦‚æœéœ€è¦æ–°åŠ æ—¥å¿—åœ°æ–¹çš„ä¸Šä¸€æ¡çš„termæˆ–indexå’Œleaderè®°å½•çš„ä¸ä¸€è‡´ï¼Œå°±è¡¨ç¤ºä¸ä¸€è‡´ã€‚<br>
éœ€è¦åŒæ­¥æ—¥å¿—åºåˆ—log[x:]ï¼Œå¹¶ä¸”è¦ä¿è¯açš„log[1:x]å’Œè‡ªå·±çš„log[1:x]ä¿æŒä¸€è‡´ï¼Œå…³é”®ç‚¹åœ¨äºlog[x-1]ï¼Œå³log[nextIndex[a]-1]ã€‚<br>
æ‰€ä»¥å½“appendEntryåˆ°serverXçš„æ—¶å€™ï¼Œéœ€è¦çŸ¥é“leaderè®°å½•ä¸­ï¼Œè¿™ä¸ªæœåŠ¡å™¨çš„ä¸Šæ¡term/index, è¿˜éœ€è¦å½“å‰sXè®°å½•çš„è‡ªèº«çš„term/indexã€‚<br>
leaderçš„è®°å½•ï¼š<br>
args.prevLogIndex &lt;â€”â€” leader.nextIndex[sX] - 1ï¼ˆN-1ï¼‰<br>
args.prevLogTerm &lt;â€”â€” leader.log[N-1].Term<br>
* å¤åˆ¶çš„entryä»leader.nextIndex[sX]å¼€å§‹ï¼šrf.logs[rf.nextIndex[sX]:]<br>
rfè‡ªå·±çš„è®°å½•ï¼š<br>
* <em>å¦‚æœsXçš„indexè¿‡å¤§ï¼Œå°šä¸”å†è®®ï¼Œå› ä¸ºå¯èƒ½æœ‰æš‚å­˜çš„entryï¼Œå¦‚æœè¿‡å°å°±é“ä¸ä¸€è‡´ï¼Œå› ä¸ºleaderå¤ªæ¿€è¿›äº†ä¼šå¯¼è‡´sXä¸è¿ç»­ï¼Œæ›´æ—©çš„æœ¬ä¹Ÿåº”è¯¥copyè¿›æ¥ï¼Œsoç›´æ¥è¿”å›ï¼›ä½†æ˜¯termåªè¦ä¸ä¸€æ ·ï¼Œå°±é“ä¸ä¸€è‡´</em>ã€‚</p>
<p>â‘¡ é¢†å¯¼äººç»å¯¹ä¸ä¼šåˆ é™¤æˆ–è€…è¦†ç›–æœ¬èº«çš„æ—¥å¿—ï¼Œåªä¼šå¢é•¿ã€‚<br>
â€”&gt; which meansï¼Œå½“æ•°æ®ä¸ä¸€è‡´æ—¶ï¼Œä¸€åˆ‡ä»¥leaderæ•°æ®ä¸ºå‡†ã€‚leaderä¼šå¼ºåˆ¶å¤åˆ¶æœ¬èº«çš„logåˆ°æ•°æ®ä¸ä¸€è‡´çš„leaderï¼Œä»è€Œä½¿å…¨éƒ¨nodeéƒ½ä¿æŒä¸€è‡´ã€‚<br>
ï¼Ÿå¦‚æœæ–°leaderè¦†ç›–äº†æ—§leaderçš„logå‘¢ï¼Ÿ<br>
â€”&gt; ä¼šå‘ç”Ÿã€‚ä½†æ–°ä»»é¢†å¯¼è€…å¿…å®šä¼šåŒ…å«æœ€æ–°ä¸€æ¡æ—¥å¿—ï¼Œå³æ–°ä»»é¢†å¯¼è€…çš„æ•°æ®å’Œæ—§é¢†å¯¼è€…çš„æ•°æ®å°±ç®—æ˜¯ä¸ä¸€è‡´çš„ï¼Œä¹Ÿä»…ä»…æ˜¯æœªæäº¤çš„æ—¥å¿—ï¼Œå³å®¢æˆ·ç«¯è¿˜æ²¡æœ‰è·å¾—å›å¤ï¼Œæ­¤æ—¶å°±ç®—æ˜¯æ–°ä»»é¢†å¯¼è€…è¦†ç›–æ—§é¢†å¯¼è€…çš„æ•°æ®ï¼Œå®¢æˆ·ç«¯è·å¾—å›å¤ï¼ŒæŒä¹…åŒ–æ—¥å¿—å¤±è´¥ã€‚ä»å®¢æˆ·ç«¯çš„è§’åº¦æ¥å¼€ï¼Œå¹¶æ— äº§ç”Ÿæ•°æ®ä¸ä¸€è‡´çš„çŠ¶å†µã€‚</p>
</li>
<li>
<p>æ—¥å¿—è¢«åº”ç”¨åˆ°å„nodeæœ‰ä¸¤ä¸ªé˜¶æ®µï¼ˆlike ä¸¤é˜¶æ®µæäº¤ï¼‰ï¼š<br>
â‘  leader å¸¦logå‘é€appendEntries RPC<br>
â‘¡ leaderåˆ¤æ–­logæ˜¯å¦å¯è¢«æäº¤ï¼ˆlen(peers)/2+1 éƒ½æˆåŠŸï¼‰ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™å›å¤clientï¼›è€Œåå†å¹¶è¡Œçš„å†å‘é€å¸¦logçš„PRCï¼Œfollowerçœ‹åˆ°è¯¥logå¯è¢«æäº¤ï¼Œåˆ™åº”ç”¨åˆ°å„è‡ªçš„çŠ¶æ€æœºä¸­ã€‚<br>
æš‚æ—¶æ²¡æˆåŠŸçš„followerï¼Œleaderä¼šä¸€ç›´å‘RPCï¼Œç›´åˆ°æ‰€æœ‰nodeéƒ½ä¸€è‡´ã€‚<br>
* <em>å’Œä¸¤é˜¶æ®µæäº¤çš„å·®å¼‚æ˜¯ï¼šlen(peers)/2+1 æˆåŠŸ vs å…¨nodeæˆåŠŸ</em>ã€‚</p>
</li>
<li>
<p>æ—¥å¿—ä¸ä¸€è‡´æ—¶æ€ä¹ˆåŠï¼š<br>
é™„åŠ logçš„PRCé‡Œï¼Œä¸€è‡´æ€§æ£€æŸ¥å¤±è´¥æ—¶ï¼Œfollowä¼šæ‹’ç»è¯·æ±‚ã€‚leaderå‘ç°è¯·æ±‚å¤±è´¥åï¼Œä¼šå°†é™„åŠ logçš„index-1ï¼Œå†æ¬¡å°è¯•å‘é€RPCï¼Œç›´è‡³æˆåŠŸã€‚<br>
* <em>å°ä¼˜åŒ–ï¼šfolloweræ‹’ç»ä¹‹åï¼Œå¯ä»¥ç›´æ¥è¿”å›åŒ…å«å†²çªçš„æ¡ç›®çš„ä»»æœŸå·å’Œæœ¬èº«å­˜å‚¨çš„é‚£ä¸ªä»»æœŸçš„æœ€å…ˆçš„ç´¢å¼•åœ°å€ã€‚å‡å°‘é€šä¿¡æ¬¡æ•°</em>ã€‚</p>
</li>
</ol>
<h4 id="å¿ƒè·³æ—¶é—´å’Œé€‰ä¸¾æ—¶é—´">å¿ƒè·³æ—¶é—´å’Œé€‰ä¸¾æ—¶é—´ <a href="#%e5%bf%83%e8%b7%b3%e6%97%b6%e9%97%b4%e5%92%8c%e9%80%89%e4%b8%be%e6%97%b6%e9%97%b4" style="border:none;"></a></h4><p>Leaderåœ¨è¢«é€‰ä¸¾å‡ºæ¥åå°±ä¼šå¼€å§‹å‘å…¶ä»–Serverå‘é€å¿ƒè·³åŒ…ï¼Œå…¶ä»–Serveråœ¨æ”¶åˆ°å¿ƒè·³åŒ…åï¼Œå°±å°†è‡ªå·±çš„çŠ¶æ€ä¿æŒä¸ºFollowerï¼Œç›´åˆ°ä¸‹ä¸€æ¬¡æŒç»­é€‰ä¸¾è¶…æ—¶æ—¶é—´æ²¡æœ‰æ”¶åˆ°ä»»ä½•æ¶ˆæ¯ã€‚</p>
<p>which meansï¼šLeaderå‘é€å¿ƒè·³åŒ…å­˜åœ¨ç€ä¸€ä¸ªå¿ƒè·³åŒ…å‘é€é—´éš”ï¼ŒåŒæ—¶ï¼ŒFollowerä¸ºç«é€‰Leaderä¹Ÿå­˜åœ¨ä¸€ä¸ªé€‰ä¸¾Timeoutã€‚æ‰€ä»¥ï¼Œä¸ºäº†é˜²æ­¢Leaderå·²ç»é€‰ä¸¾å‡ºæ¥ï¼Œä¸”ç½‘ç»œæ²¡æœ‰Failureçš„æƒ…å†µä¸‹ï¼Œä¸€äº›Followerä»è®¤ä¸ºæ²¡æœ‰Leaderå­˜åœ¨çš„æƒ…å†µï¼Œé€‰ä¸¾Timeoutåº”è¯¥æ˜¯å¤§äºå¿ƒè·³é—´éš”çš„ã€‚</p>
<h4 id="åŒæ­¥">åŒæ­¥ <a href="#%e5%90%8c%e6%ad%a5" style="border:none;"></a></h4><p>Leaderè¢«é€‰ä¸¾å‡ºæ¥åï¼ŒLeaderå¯ä»¥å¼€å§‹æœåŠ¡æ•´ä¸ªé›†ç¾¤ï¼Œä¹Ÿå°±è¦åšåˆ°åŒæ­¥è‡ªèº«çš„æ•°æ®ç»™é›†ç¾¤ä¸­çš„å…¶ä»–Serverï¼Œå› ä¸ºï¼Œå…·æœ‰ä¿å­˜æ¥è‡ªClientçš„æ•°æ®çš„æƒåŠ›çš„åªæœ‰Leaderã€‚å…¶ä»–Serverå¦‚æœæ”¶åˆ°Clientçš„æ¶ˆæ¯ï¼Œä¼šæ‹’ç»æ¥è‡ªClientçš„æ¶ˆæ¯ï¼Œä¸”å¯ä»¥é€‰æ‹©è¿”å›Leaderçš„ä½ç½®ã€‚</p>
<h3 id="bug">bug <a href="#bug" style="border:none;"></a></h3><ul>
<li>
<p>listè¶…indexï¼š<br>
â€”&gt; appendentriesçš„åˆ¤æ–­æ¥æ”¶æ•°æ®é‚£é‡Œï¼Œä¸¤ä¸ªæ¡ä»¶è¦åˆ†å¼€å†™ã€‚</p>
</li>
<li>
<p>too many RPC bytesï¼š<br>
â€”&gt; æ³¨é‡Šå¤ªå¤š</p>
</li>
<li>
<p>failed to reach agreement<br>
â€”&gt; æŠ•ç¥¨çš„æ—¶å€™ï¼Œleaderçš„lastlogtermæ¯”æœ¬æœºlastlogtermå¤§ä¹Ÿå¯ä»¥æŠ•ç¥¨<br>
â€”&gt; ç–¯ç‹‚printï¼Œå‘ç°é™·å…¥æ­»å¾ªç¯çš„åœ°æ–¹æ‰€æœ‰äººéƒ½å˜æˆcandidateï¼Œä½†æ˜¯æ‹¿ä¸åˆ°åˆ«äººçš„ç¥¨ã€‚<br>
è¿™é‡Œè§£å†³æ–¹æ³•æ˜¯æŠŠæ”¹çŠ¶æ€çš„å¤´ä¸€å¥ï¼Œif å½“å‰çŠ¶æ€== è¦æ”¹çš„çŠ¶æ€ï¼šreturnï¼Œè¿™å¥æ³¨é‡Šæ‰äº†ã€‚è¿™æ ·å¯ä»¥é‡æ–°è®¡æ—¶ï¼Œå¢åŠ termã€‚åœ¨éšæœºçš„å½±å“ä¸‹ï¼Œä¼šæœ‰äººä»candié‡Œé¢æŒ£è„±å‡ºæ¥ã€‚<br>
åº”è¯¥è¿˜æœ‰åˆ«çš„åœ°æ–¹ä¸è§„èŒƒï¼Œåº”è¯¥æ˜¯åœ¨æŠ•ç¥¨çš„æ—¶å€™ï¼Œæ²¡æœ‰äººç»™å®ƒæŠ•ç¥¨çš„æƒ…å†µä¸‹æ€ä¹ˆä¼šæ­»é”ï¼Ÿï¼Ÿï¼Ÿ</p>
</li>
</ul>
<h2 id="lab2cpersistence">Lab2Cï¼špersistence <a href="#lab2cpersistence" style="border:none;"></a></h2><p>å°†æœ¬æ¥ä¿å­˜åœ¨å†…å­˜çš„æ•°æ®ï¼Œé€‚æ—¶ä¿å­˜å…¥diskã€‚<br>
åŒæ—¶ä¼˜åŒ–AppendEntries RPCâ€”â€”åŠ å¿«æ—¥å¿—å›æº¯</p>
<p>// æ‰¾åˆ°æ–¹ä¾¿è¿è¡Œæµ‹è¯•çš„è„šæœ¬<br>
bash go-test-many.sh 2000 8 2C</p>
<p>æµ‹è¯•ï¼š<br>
TestPersist12C<br>
TestPersist22C<br>
TestPersist32C<br>
TestFigure82C<br>
TestUnreliableAgree2C<br>
TestFigure8Unreliable2C<br>
TestReliableChurn2C<br>
TestUnreliableChurn2C</p>
<p>æŒä¹…åŒ–è¦å¤„ç†çš„ç»“æ„å’Œæµç¨‹ï¼š</p>
<ul>
<li>
<p>persist() / readPersist()<br>
å®ç°çš„æ—¶å€™å¹¶ä¸ä¼šçœŸçš„å­˜åœ¨ç£ç›˜é‡Œï¼Œè€Œæ˜¯ä» Persister å¯¹è±¡ä¿å­˜å’Œæ¢å¤æŒä¹…çŠ¶æ€ï¼ˆin persister.goï¼‰ã€‚å®ƒä¿å­˜äº†æœ€è¿‘çš„æŒä¹…åŒ–çŠ¶æ€ï¼Œraftä¹Ÿä»è¿™ä¸ªèŠ‚ç‚¹æ¢å¤åˆå§‹åŒ–ã€‚<br>
éœ€è¦æŒä¹…åŒ–çš„å±æ€§ï¼Ÿ<br>
currentTermã€votedForã€log<br>
(ä¸ºç”šä¹ˆæ˜¯è¿™å‡ ä¸ªä¸ºç”šä¹ˆä¸æ˜¯åˆ«çš„ï¼Ÿ)<br>
ä½•æ—¶å­˜å‚¨persist() ï¼Ÿ<br>
æ¯æ¬¡çŠ¶æ€æ”¹å˜çš„æ—¶å€™ã€‚<br>
å³ï¼Œé€‰ä¸¾çš„æ—¶å€™ï¼Œé™æˆfollowerçš„æ—¶å€™ï¼Œåˆå§‹åŒ–leaderçš„æ—¶å€™ï¼Œä¼ é€’logçš„æ—¶å€™ã€‚<br>
* ä¼ logçš„æ—¶å€™ã€æŠ•ç¥¨çš„æ—¶å€™è¦deferï¼›å¼€å§‹é€‰ä¸¾çš„æ—¶å€™ã€ä¸´æ—¶å˜followerçš„æ—¶å€™ã€leaderstartçš„æ—¶å€™ä¸è¦deferï¼ˆwhyï¼‰ã€‚æŠ•ç¥¨å®Œå˜leaderä¸è¦persistï¼ˆwhyï¼‰<br>
rf.persist()<br>
makeæ—¶å¼€å¯readPersist()</p>
</li>
<li>
<p>ä¼˜åŒ–AppendEntries RPCâ€”â€”åŠ å¿«æ—¥å¿—å›æº¯<br>
æœ¬æ¥æ˜¯ï¼šå¯¹äºå¤±è´¥çš„AppendEntriesè¯·æ±‚ï¼Œè®©nextIndexè‡ªå‡1<br>
ä¼˜åŒ–ä¸ºï¼šå¦‚æœæ‰¾åˆ°ä¸€ä¸ªå†²çªç‚¹ï¼Œç›´æ¥é€€å›æ­¤å†²çªç‚¹<br>
éœ€è¦å±æ€§ä¸¤ä¸ªï¼šconflictterm å’Œ conflictindex<br>
ä¼˜åŒ–1ï¼š<br>
å¦‚æœfollower.logä¸å­˜åœ¨prevLogï¼Œè®©Leaderä¸‹ä¸€æ¬¡ä»follower.logçš„æœ«å°¾å¼€å§‹åŒæ­¥æ—¥å¿—ã€‚<br>
ä¼˜åŒ–2ï¼š<br>
å¦‚æœæ˜¯å› ä¸ºprevLog.Termä¸åŒ¹é…ï¼ˆè€Œæ— æ³•å¤åˆ¶logï¼‰ï¼Œè®°follower.prevLog.Termä¸ºconflictTermã€‚<br>
â‘  å¦‚æœleader.logæ‰¾ä¸åˆ°Termä¸ºconflictTermçš„æ—¥å¿—ï¼Œåˆ™ä¸‹ä¸€æ¬¡ä»follower.logä¸­conflictTermçš„ç¬¬ä¸€ä¸ªlogçš„ä½ç½®å¼€å§‹åŒæ­¥æ—¥å¿—ã€‚<br>
â‘¡ å¦‚æœleader.logæ‰¾åˆ°äº†Termä¸ºconflictTermçš„æ—¥å¿—ï¼Œåˆ™ä¸‹ä¸€æ¬¡ä»leader.logä¸­conflictTermçš„æœ€åä¸€ä¸ªlogçš„ä¸‹ä¸€ä¸ªä½ç½®å¼€å§‹åŒæ­¥æ—¥å¿—ã€‚<br>
* æ³¨æ„æ˜¯å¦‚æœä¸Šä¸€ä¸ªï¼ˆi-1ï¼‰çš„termåŒ¹é…è¯¥followerï¼ŒnextèŠ‚ç‚¹è®¾ä¸ºi</p>
</li>
</ul></div>

    <div class="post-meta meta">
        

        <span class="tags-box">
            <svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 512 512" fill="currentColor"
                class="fas-tags">
                <path
                    d="M345 39.1L472.8 168.4c52.4 53 52.4 138.2 0 191.2L360.8 472.9c-9.3 9.4-24.5 9.5-33.9 .2s-9.5-24.5-.2-33.9L438.6 325.9c33.9-34.3 33.9-89.4 0-123.7L310.9 72.9c-9.3-9.4-9.2-24.6 .2-33.9s24.6-9.2 33.9 .2zM0 229.5V80C0 53.5 21.5 32 48 32H197.5c17 0 33.3 6.7 45.3 18.7l168 168c25 25 25 65.5 0 90.5L277.3 442.7c-25 25-65.5 25-90.5 0l-168-168C6.7 262.7 0 246.5 0 229.5zM144 144a32 32 0 1 0 -64 0 32 32 0 1 0 64 0z" />
            </svg>
            
            
            <a class="tag-link" href="/%20/tags/%E5%88%86%E5%B8%83%E5%BC%8F">åˆ†å¸ƒå¼</a>
            
            ,&nbsp;
            <a class="tag-link" href="/%20/tags/raft">Raft</a>
            
        </span>
        
    </div>

    <div class="post-paginator">
        
        
        <span class="pag-prev">
        
            
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"
                class="lucide lucide-arrow-left-from-line">
                <path d="M3 19V5" />
                <path d="m13 6-6 6 6 6" />
                <path d="M7 12h14" />
            </svg>
            </svg>
            <a href="https://cenjianxun.github.io/posts/mit-6.824/mit-6.824lab2-raft-%E8%AF%BE%E5%A0%82%E7%AC%94%E8%AE%B0/" class="jump-post">ã€MIT 6.824ã€‘Lab2 Raft è¯¾å ‚ç¬”è®°</a>
        
        </span>
  
        <span class="pag-next">
            
            <p class="jump-post">è¿™å°±æ˜¯æœ€æ–°çš„æ–‡ç« äº†</p>
            
        </span>
        
    </div>

    
    
    <div class="post-series">
        <span class="block-bar"></span>
        <header><a href="/posts/mit-6.824/">MIT6.824 - åˆ†å¸ƒå¼ç³»ç»Ÿ</a> ç³»åˆ—æ–‡ç« </header>
        
        <li>
            
            <a href="/posts/mit-6.824/mit-6.824go-thread/">ã€MIT 6.824ã€‘Go Thread</a>
            
        </li>
        
        <li>
            
            <a href="/posts/mit-6.824/mit-6.824%E5%AE%9E%E9%AA%8C%E6%95%B4%E4%BD%93%E9%85%8D%E7%BD%AE/">ã€MIT 6.824ã€‘å®éªŒæ•´ä½“é…ç½®</a>
            
        </li>
        
        <li>
            
            <a href="/posts/mit-6.824/mit-6.824lab1-mapreduce-%E8%AF%BE%E5%A0%82%E7%AC%94%E8%AE%B0/">ã€MIT 6.824ã€‘Lab1 MapReduce è¯¾å ‚ç¬”è®°</a>
            
        </li>
        
        <li>
            
            <a href="/posts/mit-6.824/mit-6.824lab1-mapreduce-%E5%AE%9E%E9%AA%8C%E8%AE%B0%E5%BD%95/">ã€MIT 6.824ã€‘Lab1 MapReduce å®éªŒè®°å½•</a>
            
        </li>
        
        <li>
            
            <a href="/posts/mit-6.824/mit-6.824lab2-raft-%E8%AF%BE%E5%A0%82%E7%AC%94%E8%AE%B0/">ã€MIT 6.824ã€‘Lab2 Raft è¯¾å ‚ç¬”è®°</a>
            
        </li>
        
        <li>
            
            <p>ã€MIT 6.824ã€‘Lab2 Raft å®éªŒè®°å½•</p>
            
        </li>
        
    </div>
    

</article>


    </div>
      </main>
      <footer class="footer">
    <p class="copyright"> Â© 2018 - 2024 &nbsp; XUN
    </p>
</footer>


    </div>
  </div>
</body>
</html>